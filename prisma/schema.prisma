  generator client {
    provider   = "prisma-client-js"
    engineType = "binary"
  }

  datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
  }

  enum UserRole {
    ADMIN
    CUSTOMER
  }

  enum AnalyticsEventType {
    PAGEVIEW
    EVENT
  }

enum AnalyticsAlarmType {
  EVENT_THRESHOLD
  ONLINE_BELOW
}

enum BIKEventType {
  PAGE_VIEW
  HEARTBEAT
  INTERACTION
  SESSION_START
  SESSION_END
  RENDER_PING
  CLIENT_ERROR
}

  model User {
    id           String               @id @default(cuid())
    email        String               @unique
    passwordHash String?
    name         String?
    role         UserRole             @default(CUSTOMER)
    createdAt    DateTime             @default(now())
    updatedAt    DateTime             @updatedAt
    userWebsites AnalyticsUserWebsite[]
  }

model AnalyticsWebsite {
  id             String                 @id @default(uuid())
  name           String
  allowedDomains String[]
  whitelistWebsiteIds String[]           @default([])
  blacklistWebsiteIds String[]           @default([])
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  userWebsites   AnalyticsUserWebsite[]
  events         AnalyticsEvent[]
  sessions       AnalyticsSession[]
  alarms         AnalyticsAlarm[]
  bikConfig      BIKConfig?
  bikEvents      BIKEvent[]
  bikSessions    BIKSession[]
  bikDailyVisitors BIKDailyVisitor[]
  bikRollupMinutes BIKRollupMinute[]
  bikRollupDays  BIKRollupDay[]
  bikCalibrationRuns BIKCalibrationRun[]
  dailySimple    AnalyticsDailySimple[]

  @@map("analytics_websites")
}

  model AnalyticsUserWebsite {
    userId    String
    websiteId String
    user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
    website   AnalyticsWebsite @relation(fields: [websiteId], references: [id], onDelete: Cascade)
    createdAt DateTime         @default(now())

    @@id([userId, websiteId])
    @@map("analytics_user_websites")
  }

model AnalyticsEvent {
  id              String             @id @default(uuid())
  websiteId       String
  type            AnalyticsEventType
  mode            String             @default("RAW")
  eventName       String?
  eventData       Json?
  visitorId       String
  sessionId       String
    url             String
  referrer        String?
  screen          String?
  language        String?
  userAgent       String?
  countryCode     String?
  clientTimestamp DateTime?
  createdAt       DateTime           @default(now())
  website         AnalyticsWebsite   @relation(fields: [websiteId], references: [id], onDelete: Cascade)

  @@index([websiteId, createdAt])
  @@index([websiteId, mode, createdAt])
  @@index([websiteId, sessionId])
  @@index([websiteId, visitorId])
  @@index([websiteId, type, createdAt])
  @@map("analytics_events")
}

model AnalyticsDailySimple {
  id                                   String   @id @default(uuid())
  siteId                               String
  day                                  DateTime
  dailyUniqueUsers                     Int
  dailyDirectUniqueUsers               Int
  dailyPageviews                       Int
  dailyAvgTimeOnSiteSecondsPerUnique   Int
  createdAt                            DateTime @default(now())
  updatedAt                            DateTime @updatedAt
  website                              AnalyticsWebsite @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@unique([siteId, day])
  @@index([siteId, day])
  @@map("analytics_daily_simple")
}

  model AnalyticsSession {
    id         String            @id @default(uuid())
    websiteId  String
    sessionId  String
    visitorId  String
    startedAt  DateTime          @default(now())
    lastSeenAt DateTime          @default(now())
    website    AnalyticsWebsite  @relation(fields: [websiteId], references: [id], onDelete: Cascade)

    @@unique([websiteId, sessionId])
    @@index([websiteId, visitorId])
    @@index([websiteId, lastSeenAt])
    @@map("analytics_sessions")
  }

model AnalyticsAlarm {
    id              String             @id @default(uuid())
    websiteId       String
    name            String
    type            AnalyticsAlarmType
    threshold       Int
    windowSeconds   Int
    isActive        Boolean            @default(true)
    lastTriggeredAt DateTime?
    createdAt       DateTime           @default(now())
    updatedAt       DateTime           @updatedAt
    website         AnalyticsWebsite   @relation(fields: [websiteId], references: [id], onDelete: Cascade)

    @@index([websiteId, isActive])
  @@map("analytics_alarms")
}

model BIKConfig {
  id                         String   @id @default(uuid())
  websiteId                  String   @unique
  sessionInactivityMinutes   Int      @default(30)
  botPvRate10s               Int      @default(30)
  botPv5Min                  Int      @default(200)
  botPeriodicStddevMs        Int      @default(200)
  botNoInteractionMs         Int      @default(2000)
  engagementMinVisibleMs     Int      @default(1000)
  engagementFullMs           Int      @default(5000)
  suspiciousSoftMode         Boolean  @default(true)
  strictSessionInactivityMinutes Int  @default(35)
  strictMaxGapSeconds        Int      @default(1800)
  strictLastPageEstimateSeconds Int  @default(30)
  strictDirectReferrerEmptyOnly Boolean @default(true)
  avgTimeMode                String   @default("SESSION")
  cookieLessAggressiveness   Float    @default(1.0)
  category                   String   @default("GENEL")
  updatedAt                  DateTime @updatedAt
  website                    AnalyticsWebsite @relation(fields: [websiteId], references: [id], onDelete: Cascade)

  @@map("bik_configs")
}

model BIKEvent {
  id                     String       @id @default(uuid())
  websiteId              String
  visitorId              String
  sessionId              String
  type                   BIKEventType
  url                    String
  referrer               String?
  isDirectSession         Boolean      @default(false)
  countryCode            String?
  userAgentHash          String?
  engagementIncrementMs  Int?
  botScore               Int?          @default(0)
  isValid                Boolean       @default(true)
  isSuspicious           Boolean       @default(false)
  isRouteChange          Boolean       @default(false)
  visitorIdSource        String?
  errorCode              String?
  pageviewKey            String?
  metadata               Json?
  ts                     DateTime      @default(now())
  website                AnalyticsWebsite @relation(fields: [websiteId], references: [id], onDelete: Cascade)

  @@index([websiteId, ts])
  @@index([websiteId, sessionId])
  @@index([websiteId, visitorId])
  @@index([websiteId, type, ts])
  @@map("bik_events")
}

model BIKSession {
  id            String   @id @default(uuid())
  websiteId     String
  visitorId     String
  sessionId     String
  startedAt     DateTime @default(now())
  lastSeenAt    DateTime @default(now())
  endedAt       DateTime?
  engagementMs  Int      @default(0)
  isValid       Boolean  @default(true)
  isSuspicious  Boolean  @default(false)
  isDirect      Boolean  @default(false)
  countryCode   String?
  website       AnalyticsWebsite @relation(fields: [websiteId], references: [id], onDelete: Cascade)

  @@unique([websiteId, sessionId])
  @@index([websiteId, visitorId])
  @@index([websiteId, lastSeenAt])
  @@map("bik_sessions")
}

model BIKDailyVisitor {
  id               String   @id @default(uuid())
  websiteId        String
  day              DateTime
  visitorId        String
  hasValidSession  Boolean  @default(false)
  hasDirectSession Boolean  @default(false)
  engagementMs     Int      @default(0)
  isSuspicious     Boolean  @default(false)
  countryCode      String?
  updatedAt        DateTime @updatedAt
  website          AnalyticsWebsite @relation(fields: [websiteId], references: [id], onDelete: Cascade)

  @@unique([websiteId, day, visitorId])
  @@index([websiteId, day])
  @@map("bik_daily_visitors")
}

model BIKRollupMinute {
  id               String   @id @default(uuid())
  websiteId        String
  minuteTs         DateTime
  validUnique      Int      @default(0)
  validDirectUnique Int     @default(0)
  validSessions    Int      @default(0)
  pageviews        Int      @default(0)
  pageviewsRaw     Int      @default(0)
  routeChangePageviews Int  @default(0)
  renderPings      Int      @default(0)
  dedupedPageviews Int      @default(0)
  clientErrorCount Int      @default(0)
  engagementMsSum  Int      @default(0)
  suspiciousCount  Int      @default(0)
  invalidCount     Int      @default(0)
  updatedAt        DateTime @updatedAt
  website          AnalyticsWebsite @relation(fields: [websiteId], references: [id], onDelete: Cascade)

  @@unique([websiteId, minuteTs])
  @@index([websiteId, minuteTs])
  @@map("bik_rollup_minute")
}

model BIKRollupDay {
  id                          String   @id @default(uuid())
  websiteId                   String
  day                         DateTime
  dailyUniqueVisitors         Int      @default(0)
  dailyDirectUniqueVisitors   Int      @default(0)
  dailySessions               Int      @default(0)
  dailyPageviews              Int      @default(0)
  dailyAvgTimeOnSiteSeconds   Int      @default(0)
  directRatio                 Float    @default(0)
  foreignAdjustmentApplied    Boolean  @default(false)
  healthScore                 Int      @default(100)
  category                    String?
  updatedAt                   DateTime @updatedAt
  website                     AnalyticsWebsite @relation(fields: [websiteId], references: [id], onDelete: Cascade)

  @@unique([websiteId, day])
  @@index([websiteId, day])
  @@map("bik_rollup_day")
}

model BIKCalibrationRun {
  id            String   @id @default(uuid())
  websiteId     String
  day           DateTime
  bikMetrics    Json
  localMetrics  Json
  resultConfig  Json
  createdAt     DateTime @default(now())
  website       AnalyticsWebsite @relation(fields: [websiteId], references: [id], onDelete: Cascade)

  @@index([websiteId, day])
  @@map("bik_calibration_runs")
}
